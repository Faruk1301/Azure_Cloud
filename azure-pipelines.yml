trigger:
  branches:
    include:
      - main  # Change if using a different branch

pool:
  vmImage: 'ubuntu-latest'

stages:
- stage: Build
  jobs:
  - job: Build
    steps:
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '3.x'

    - script: |
        python -m venv venv
        source venv/bin/activate
        pip install -r requirements.txt
      displayName: 'Install dependencies'

    - script: pytest  # Run tests (modify if needed)
      displayName: 'Run Tests'

    - task: ArchiveFiles@2
      inputs:
        rootFolderOrFile: '$(Build.SourcesDirectory)'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/app.zip'

    - publish: $(Build.ArtifactStagingDirectory)/app.zip
      artifact: app

- stage: Dev
  dependsOn: Build
  jobs:
  - job: DeployToDev
    steps:
    - task: AzureWebApp@1
      inputs:
        azureSubscription: 'Azure for Students'  # Your Subscription Name
        appName: 'my-python-app'  # Your Dev App Service
        package: '$(Pipeline.Workspace)/app/app.zip'

- stage: Stage
  dependsOn: Dev
  jobs:
  - job: DeployToStage
    steps:
    - task: AzureWebApp@1
      inputs:
        azureSubscription: 'Azure for Students'  # Your Subscription Name
        appName: 'my-python-app-staging'  # Your Staging App Service
        package: '$(Pipeline.Workspace)/app/app.zip'

